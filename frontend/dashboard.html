<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - GeoVera Intelligence</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <!-- Accessibility CSS -->
    <link rel="stylesheet" href="css/accessibility.css">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* GeoVera Brand Colors - WIRED Style */
            --gv-hero: #16A34A;
            --gv-anchor: #0B0F19;
            --gv-body: #6B7280;
            --gv-canvas: #FFFFFF;
            --gv-divider: #E5E7EB;
            --gv-bg-light: #F9FAFB;
            --gv-risk: #DC2626;
            --gv-secondary: #2563EB;

            /* Typography - WIRED Editorial */
            --font-display: Georgia, 'Times New Roman', serif;
            --font-body: 'Inter', system-ui, -apple-system, sans-serif;
        }

        body {
            font-family: var(--font-body);
            background: var(--gv-bg-light);
            color: var(--gv-anchor);
            line-height: 1.6;
            min-height: 100vh;
        }

        /* Header - WIRED Dark Style */
        .site-header {
            background: var(--gv-anchor);
            color: white;
            border-bottom: 4px solid var(--gv-hero);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .header-container {
            max-width: 1440px;
            margin: 0 auto;
            padding: 12px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            min-height: 72px;
        }

        .header-logo {
            display: flex;
            align-items: center;
            gap: 12px;
            text-decoration: none;
            color: white;
        }

        .logo-icon {
            width: 44px;
            height: 44px;
            background: var(--gv-hero);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 20px;
            color: white;
        }

        .logo-text {
            font-family: var(--font-display);
            font-weight: 700;
            font-size: 24px;
            letter-spacing: -0.02em;
            color: white;
        }

        /* Desktop Navigation */
        .nav-desktop {
            display: flex;
            align-items: center;
            gap: 32px;
        }

        .nav-link {
            color: white;
            text-decoration: none;
            font-size: 14px;
            font-weight: 600;
            padding: 12px 16px;
            transition: color 0.2s;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            min-height: 44px;
            display: flex;
            align-items: center;
        }

        .nav-link:hover {
            color: var(--gv-hero);
        }

        .nav-link.active {
            color: var(--gv-hero);
        }

        .user-menu {
            position: relative;
        }

        .user-button {
            background: var(--gv-hero);
            color: white;
            border: none;
            padding: 12px 20px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            min-height: 44px;
            min-width: 44px;
            display: flex;
            align-items: center;
            gap: 8px;
            border-radius: 0;
        }

        .user-button:hover {
            background: #15803d;
        }

        /* Mobile Menu Toggle */
        .mobile-menu-toggle {
            display: none;
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            min-width: 44px;
            min-height: 44px;
            padding: 8px;
        }

        /* Main Container */
        .main-container {
            max-width: 1440px;
            margin: 0 auto;
            padding: 32px 24px;
        }

        /* Welcome Section */
        .welcome-section {
            background: white;
            border: 2px solid var(--gv-divider);
            padding: 32px;
            margin-bottom: 32px;
        }

        .welcome-title {
            font-family: var(--font-display);
            font-size: 36px;
            font-weight: 700;
            color: var(--gv-anchor);
            margin-bottom: 8px;
            letter-spacing: -0.02em;
        }

        .welcome-subtitle {
            font-size: 16px;
            color: var(--gv-body);
            margin-bottom: 24px;
        }

        .tier-badge {
            display: inline-block;
            background: var(--gv-hero);
            color: white;
            padding: 6px 16px;
            font-size: 12px;
            font-weight: 700;
            letter-spacing: 0.05em;
            text-transform: uppercase;
            border-radius: 0;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }

        .stat-card {
            background: white;
            border: 2px solid var(--gv-divider);
            padding: 24px;
            transition: transform 0.2s, border-color 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            border-color: var(--gv-hero);
        }

        .stat-label {
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--gv-body);
            margin-bottom: 8px;
        }

        .stat-value {
            font-family: var(--font-display);
            font-size: 32px;
            font-weight: 700;
            color: var(--gv-anchor);
            letter-spacing: -0.02em;
        }

        .stat-change {
            font-size: 14px;
            margin-top: 8px;
        }

        .stat-change.positive {
            color: var(--gv-hero);
        }

        .stat-change.negative {
            color: var(--gv-risk);
        }

        /* Quick Actions */
        .quick-actions {
            background: white;
            border: 2px solid var(--gv-divider);
            padding: 32px;
            margin-bottom: 32px;
        }

        .section-title {
            font-family: var(--font-display);
            font-size: 24px;
            font-weight: 700;
            color: var(--gv-anchor);
            margin-bottom: 24px;
            letter-spacing: -0.02em;
        }

        .actions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }

        .action-button {
            background: var(--gv-hero);
            color: white;
            border: none;
            padding: 16px 24px;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            border-radius: 0;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            min-height: 44px;
            transition: all 0.2s;
            text-decoration: none;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .action-button:hover {
            background: #15803d;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(22, 163, 74, 0.3);
        }

        .action-button.secondary {
            background: transparent;
            color: var(--gv-anchor);
            border: 2px solid var(--gv-anchor);
        }

        .action-button.secondary:hover {
            background: var(--gv-anchor);
            color: white;
        }

        /* Recent Activity */
        .activity-section {
            background: white;
            border: 2px solid var(--gv-divider);
            padding: 32px;
        }

        .activity-list {
            list-style: none;
        }

        .activity-item {
            padding: 16px 0;
            border-bottom: 1px solid var(--gv-divider);
            display: flex;
            align-items: flex-start;
            gap: 16px;
        }

        .activity-item:last-child {
            border-bottom: none;
        }

        .activity-icon {
            width: 44px;
            height: 44px;
            background: var(--gv-bg-light);
            border: 2px solid var(--gv-divider);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            flex-shrink: 0;
        }

        .activity-content {
            flex: 1;
        }

        .activity-title {
            font-weight: 600;
            color: var(--gv-anchor);
            margin-bottom: 4px;
        }

        .activity-meta {
            font-size: 14px;
            color: var(--gv-body);
        }

        /* Usage Limit Info */
        .usage-info {
            background: white;
            border: 2px solid var(--gv-divider);
            padding: 24px 32px;
            margin-bottom: 32px;
        }

        .usage-info h3 {
            font-family: var(--font-display);
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 16px;
            color: var(--gv-anchor);
        }

        .usage-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }

        .usage-item {
            padding: 12px;
            background: var(--gv-bg-light);
            border-left: 4px solid var(--gv-hero);
        }

        .usage-label {
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--gv-body);
            margin-bottom: 8px;
        }

        .usage-value {
            font-size: 20px;
            font-weight: 700;
            color: var(--gv-anchor);
        }

        .usage-bar {
            background: var(--gv-divider);
            height: 6px;
            border-radius: 0;
            overflow: hidden;
            margin-top: 8px;
        }

        .usage-fill {
            background: var(--gv-hero);
            height: 100%;
            transition: width 0.3s ease;
        }

        .usage-fill.warning {
            background: #f59e0b;
        }

        .usage-fill.danger {
            background: var(--gv-risk);
        }

        .upgrade-note {
            margin-top: 16px;
            padding: 12px;
            background: var(--gv-bg-light);
            border-left: 4px solid var(--gv-secondary);
            font-size: 14px;
            color: var(--gv-body);
        }

        .upgrade-note a {
            color: var(--gv-secondary);
            font-weight: 600;
            text-decoration: none;
        }

        .upgrade-note a:hover {
            text-decoration: underline;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .nav-desktop {
                display: none;
            }

            .mobile-menu-toggle {
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .welcome-title {
                font-size: 28px;
            }

            .upgrade-banner {
                flex-direction: column;
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <!-- Skip to Main Content Link - WCAG 2.1 AA -->
    <a href="#main-content" class="skip-link">Skip to main content</a>

    <!-- Live Region for Screen Reader Announcements -->
    <div role="status" aria-live="polite" aria-atomic="true" class="sr-only live-region" id="announcements"></div>

    <!-- Header -->
    <header class="site-header" role="banner">
        <div class="header-container">
            <a href="/frontend/index.html" class="header-logo" aria-label="GeoVera Intelligence - Return to homepage">
                <div class="logo-icon" aria-hidden="true">G</div>
                <span class="logo-text">GeoVera</span>
            </a>

            <!-- Desktop Navigation -->
            <nav class="nav-desktop" aria-label="Main navigation">
                <a href="/frontend/dashboard.html" class="nav-link active" aria-current="page">Dashboard</a>
                <a href="/frontend/insights.html" class="nav-link">Insights</a>
                <a href="/frontend/hub.html" class="nav-link">Hub</a>
                <a href="/frontend/radar.html" class="nav-link">Radar</a>
                <a href="/frontend/content-studio.html" class="nav-link">Content Studio</a>
                <a href="/frontend/chat.html" class="nav-link">AI Chat</a>
                <a href="/frontend/settings.html" class="nav-link">Settings</a>
            </nav>

            <!-- User Menu -->
            <div class="user-menu">
                <button class="user-button" id="user-btn" aria-label="User menu" aria-haspopup="true" aria-expanded="false">
                    <span id="user-name">Account</span>
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                    </svg>
                </button>
            </div>

            <!-- Mobile Menu Toggle -->
            <button class="mobile-menu-toggle" id="mobile-toggle" aria-label="Toggle mobile menu" aria-expanded="false">
                <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
                </svg>
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-container" id="main-content" role="main">
        <!-- Usage Limits Info -->
        <div class="usage-info" id="usage-info" role="region" aria-label="Usage limits">
            <h3>Your Monthly Usage</h3>
            <div class="usage-grid" id="usage-grid">
                <!-- Usage items will be populated by JavaScript -->
            </div>
            <div class="upgrade-note" id="upgrade-note" style="display: none;">
                Need more? <a href="/frontend/pricing.html">Upgrade your plan</a> for higher limits.
            </div>
        </div>

        <!-- Welcome Section -->
        <section class="welcome-section" aria-labelledby="welcome-title">
            <h1 class="welcome-title" id="welcome-title">Welcome back, <span id="brand-name">Brand</span></h1>
            <p class="welcome-subtitle">Here's what's happening with your influencer marketing today</p>
            <span class="tier-badge" id="tier-badge" role="status" aria-label="Current subscription tier">BASIC TIER</span>
        </section>

        <!-- Stats Grid -->
        <section class="stats-grid" aria-label="Performance metrics">
            <div class="stat-card">
                <div class="stat-label">Total Creators</div>
                <div class="stat-value" id="stat-creators">0</div>
                <div class="stat-change positive" role="status" aria-live="polite">
                    <span aria-label="Change from last period">+0 this week</span>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-label">Hub Collections</div>
                <div class="stat-value" id="stat-collections">0</div>
                <div class="stat-change positive" role="status" aria-live="polite">
                    <span aria-label="Change from last period">+0 this month</span>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-label">Insights Completed</div>
                <div class="stat-value" id="stat-insights">0</div>
                <div class="stat-change positive" role="status" aria-live="polite">
                    <span aria-label="Change from last period">+0 today</span>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-label">Chat Messages</div>
                <div class="stat-value" id="stat-messages">0</div>
                <div class="stat-change" role="status" aria-live="polite">
                    <span aria-label="Remaining this month">0 remaining</span>
                </div>
            </div>
        </section>

        <!-- Quick Actions -->
        <section class="quick-actions" aria-labelledby="quick-actions-title">
            <h2 class="section-title" id="quick-actions-title">Quick Actions</h2>
            <div class="actions-grid" role="list">
                <a href="/frontend/insights.html" class="action-button" role="listitem" aria-label="View daily insights tasks">
                    View Insights
                </a>
                <a href="/frontend/hub.html" class="action-button" role="listitem" aria-label="Manage hub collections">
                    Manage Hub
                </a>
                <a href="/frontend/chat.html" class="action-button secondary" role="listitem" aria-label="Start AI chat session">
                    AI Chat
                </a>
                <a href="/frontend/content-studio.html" class="action-button secondary" role="listitem" aria-label="Create content in studio" id="content-studio-btn">
                    Content Studio
                </a>
            </div>
        </section>

        <!-- Recent Activity -->
        <section class="activity-section" aria-labelledby="activity-title">
            <h2 class="section-title" id="activity-title">Recent Activity</h2>
            <ul class="activity-list" id="activity-list" role="list">
                <li class="activity-item" role="listitem">
                    <div class="activity-icon" aria-hidden="true">ðŸ“Š</div>
                    <div class="activity-content">
                        <div class="activity-title">Welcome to GeoVera</div>
                        <div class="activity-meta">Get started by exploring your dashboard</div>
                    </div>
                </li>
            </ul>
        </section>
    </main>

    <!-- Supabase & Config -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="/frontend/config.js" type="module"></script>
    <script type="module">
        // SUPABASE CONFIG - Load from environment variables
        import config from '/frontend/config.js';

        const supabase = window.supabase.createClient(
            config.supabase.url,
            config.supabase.anonKey
        );

        // Check authentication
        async function checkAuth() {
            try {
                const { data: { user }, error } = await supabase.auth.getUser();

                if (error || !user) {
                    window.location.href = 'login.html';
                    return null;
                }

                // GUARD: Check subscription tier (NO FREE TIER!)
                const { data: subscription } = await supabase
                    .from('gv_subscriptions')
                    .select('plan, status')
                    .eq('user_id', user.id)
                    .eq('status', 'active')
                    .single();

                if (!subscription) {
                    alert('Please subscribe to a plan to access the dashboard');
                    window.location.href = 'pricing.html';
                    return null;
                }

                return user;
            } catch (err) {
                console.error('Auth check failed:', err);
                window.location.href = 'login.html';
                return null;
            }
        }

        // Load dashboard data
        async function loadDashboard() {
            const user = await checkAuth();
            if (!user) return;

            try {
                // Get user brand
                const { data: brands } = await supabase
                    .from('user_brands')
                    .select('brand_id, role, brands(brand_name)')
                    .eq('user_id', user.id)
                    .eq('role', 'owner')
                    .single();

                if (brands && brands.brands) {
                    document.getElementById('brand-name').textContent = brands.brands.brand_name;
                }

                // Get subscription tier
                const { data: subscription } = await supabase
                    .from('gv_subscriptions')
                    .select('tier_name')
                    .eq('user_id', user.id)
                    .single();

                if (subscription) {
                    const tierName = subscription.tier_name.toUpperCase();
                    document.getElementById('tier-badge').textContent = `${tierName} TIER`;
                }

                // Load tier limits and usage
                await loadUsageLimits(user.id, brands?.brand_id);

                // Load stats (placeholder - implement real stats later)
                document.getElementById('stat-creators').textContent = '0';
                document.getElementById('stat-collections').textContent = '0';
                document.getElementById('stat-insights').textContent = '0';
                document.getElementById('stat-messages').textContent = '0';

                // Announce page loaded to screen readers
                document.getElementById('announcements').textContent = 'Dashboard loaded successfully';

            } catch (err) {
                console.error('Error loading dashboard:', err);
            }
        }

        // Load usage limits and display them
        async function loadUsageLimits(userId, brandId) {
            try {
                // Get tier limits from subscription
                const { data: subscription } = await supabase
                    .from('gv_subscriptions')
                    .select(`
                        tier_name,
                        gv_subscription_tiers (
                            daily_questions,
                            articles_per_month,
                            images_per_month,
                            videos_per_month
                        )
                    `)
                    .eq('user_id', userId)
                    .single();

                if (!subscription || !subscription.gv_subscription_tiers) {
                    console.error('No subscription tier found');
                    return;
                }

                const limits = subscription.gv_subscription_tiers;
                const tierName = subscription.tier_name;

                // Get current usage
                const currentMonth = new Date().toISOString().slice(0, 7) + '-01';
                const { data: usage } = await supabase
                    .from('gv_tier_usage')
                    .select('*')
                    .eq('brand_id', brandId)
                    .eq('usage_month', currentMonth)
                    .single();

                // Default to 0 if no usage record exists yet
                const currentUsage = usage || {
                    insights_generated: 0,
                    content_articles: 0,
                    content_images: 0,
                    content_videos: 0
                };

                // Calculate usage percentages and display
                const usageItems = [
                    {
                        label: 'Daily Insights',
                        used: currentUsage.insights_generated || 0,
                        limit: limits.daily_questions * 30, // Monthly estimate
                        description: `${limits.daily_questions}/day`
                    },
                    {
                        label: 'AI Articles',
                        used: currentUsage.content_articles || 0,
                        limit: limits.articles_per_month,
                        description: 'per month'
                    },
                    {
                        label: 'AI Images',
                        used: currentUsage.content_images || 0,
                        limit: limits.images_per_month,
                        description: 'per month'
                    },
                    {
                        label: 'Video Scripts',
                        used: currentUsage.content_videos || 0,
                        limit: limits.videos_per_month,
                        description: 'per month'
                    }
                ];

                const usageGrid = document.getElementById('usage-grid');
                usageGrid.innerHTML = usageItems.map(item => {
                    const percentage = item.limit > 0 ? (item.used / item.limit) * 100 : 0;
                    let fillClass = '';
                    if (percentage >= 90) fillClass = 'danger';
                    else if (percentage >= 70) fillClass = 'warning';

                    return `
                        <div class="usage-item">
                            <div class="usage-label">${item.label}</div>
                            <div class="usage-value">${item.used}/${item.limit}</div>
                            <div class="usage-bar">
                                <div class="usage-fill ${fillClass}" style="width: ${Math.min(percentage, 100)}%"></div>
                            </div>
                            <div style="font-size: 12px; color: var(--gv-body); margin-top: 4px;">${item.description}</div>
                        </div>
                    `;
                }).join('');

                // Show upgrade note if usage is high on any item
                const anyHighUsage = usageItems.some(item => {
                    const pct = item.limit > 0 ? (item.used / item.limit) * 100 : 0;
                    return pct >= 70;
                });

                if (anyHighUsage || tierName === 'basic') {
                    document.getElementById('upgrade-note').style.display = 'block';
                }

            } catch (err) {
                console.error('Error loading usage limits:', err);
            }
        }

        // User menu functionality
        document.getElementById('user-btn').addEventListener('click', function() {
            const expanded = this.getAttribute('aria-expanded') === 'true';
            this.setAttribute('aria-expanded', !expanded);

            // Implement dropdown menu here
            if (!expanded) {
                window.location.href = 'settings.html';
            }
        });

        // Initialize
        loadDashboard();
        console.log('GeoVera Dashboard Ready');
    </script>
</body>
</html>
