<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Content Studio - GeoVera</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #0a0a0a;
            color: #ffffff;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        .header {
            margin-bottom: 40px;
        }

        .header h1 {
            font-size: 42px;
            font-weight: 700;
            margin-bottom: 12px;
            background: linear-gradient(135deg, #16A34A 0%, #22C55E 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header p {
            font-size: 18px;
            color: #94a3b8;
        }

        /* Upgrade Prompt for Free Tier */
        .upgrade-prompt {
            display: none;
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            border: 2px solid #16A34A;
            border-radius: 16px;
            padding: 60px 40px;
            text-align: center;
            margin-top: 80px;
        }

        .upgrade-prompt.show {
            display: block;
        }

        .upgrade-prompt h2 {
            font-size: 32px;
            margin-bottom: 20px;
            color: #16A34A;
        }

        .upgrade-prompt p {
            font-size: 18px;
            color: #cbd5e1;
            margin-bottom: 30px;
        }

        .tier-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 24px;
            margin: 40px 0;
        }

        .tier-card {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 12px;
            padding: 30px;
            text-align: left;
        }

        .tier-card h3 {
            font-size: 24px;
            margin-bottom: 12px;
            color: #16A34A;
        }

        .tier-card .price {
            font-size: 36px;
            font-weight: 700;
            margin-bottom: 20px;
        }

        .tier-card ul {
            list-style: none;
            margin-bottom: 24px;
        }

        .tier-card li {
            padding: 8px 0;
            color: #cbd5e1;
        }

        .tier-card li:before {
            content: "‚úì ";
            color: #16A34A;
            font-weight: bold;
        }

        .btn-upgrade {
            display: inline-block;
            background: #16A34A;
            color: white;
            padding: 16px 32px;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 600;
            font-size: 18px;
            transition: all 0.3s ease;
        }

        .btn-upgrade:hover {
            background: #15803d;
            transform: translateY(-2px);
        }

        .note {
            margin-top: 30px;
            padding: 20px;
            background: #1e293b;
            border-left: 4px solid #16A34A;
            border-radius: 8px;
            color: #cbd5e1;
        }

        /* Content Studio */
        .content-studio {
            display: none;
        }

        .content-studio.show {
            display: block;
        }

        .tabs {
            display: flex;
            gap: 12px;
            margin-bottom: 32px;
            border-bottom: 2px solid #1e293b;
        }

        .tab {
            padding: 16px 24px;
            background: transparent;
            border: none;
            color: #94a3b8;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }

        .tab.active {
            color: #16A34A;
            border-bottom-color: #16A34A;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 24px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #cbd5e1;
            font-weight: 500;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px 16px;
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 8px;
            color: #ffffff;
            font-size: 16px;
        }

        .form-group textarea {
            min-height: 120px;
            resize: vertical;
        }

        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #cbd5e1;
        }

        .checkbox-label input[type="checkbox"] {
            width: auto;
        }

        .btn-generate {
            background: #16A34A;
            color: white;
            padding: 14px 32px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-generate:hover {
            background: #15803d;
        }

        .btn-generate:disabled {
            background: #334155;
            cursor: not-allowed;
        }

        .quota-info {
            background: #1e293b;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 24px;
            border-left: 4px solid #16A34A;
        }

        .quota-bar {
            background: #0f172a;
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 8px;
        }

        .quota-fill {
            background: linear-gradient(90deg, #16A34A 0%, #22C55E 100%);
            height: 100%;
            transition: width 0.3s ease;
        }

        .alert {
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 24px;
            display: none;
        }

        .alert.show {
            display: block;
        }

        .alert.success {
            background: #166534;
            border-left: 4px solid #16A34A;
        }

        .alert.error {
            background: #7f1d1d;
            border-left: 4px solid #dc2626;
        }

        .loading {
            text-align: center;
            padding: 40px;
        }

        .spinner {
            border: 3px solid #334155;
            border-top: 3px solid #16A34A;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .content-library {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 24px;
            margin-top: 32px;
        }

        .content-card {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 12px;
            padding: 24px;
            transition: all 0.3s ease;
        }

        .content-card:hover {
            border-color: #16A34A;
            transform: translateY(-4px);
        }

        .content-card h3 {
            font-size: 20px;
            margin-bottom: 12px;
            color: #16A34A;
        }

        .content-card .meta {
            font-size: 14px;
            color: #94a3b8;
            margin-bottom: 8px;
        }

        .content-card .platforms {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .platform-tag {
            background: #0f172a;
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 12px;
            color: #16A34A;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Content Studio</h1>
            <p>AI-powered content generation for your brand</p>
        </div>

        <div id="alert" class="alert"></div>

        <!-- Upgrade Prompt (Free Tier) -->
        <div id="upgradePrompt" class="upgrade-prompt">
            <h2>üé® Content Generation Requires Paid Subscription</h2>
            <p>Upgrade to unlock AI-powered content creation for your brand</p>

            <div class="tier-options">
                <div class="tier-card">
                    <h3>Basic</h3>
                    <div class="price">$399<span style="font-size:18px">/mo</span></div>
                    <ul>
                        <li>1 AI Article per month</li>
                        <li>1 AI Image per month</li>
                        <li>5 Keywords tracking</li>
                        <li>5 Daily Insights</li>
                    </ul>
                </div>

                <div class="tier-card">
                    <h3>Premium</h3>
                    <div class="price">$699<span style="font-size:18px">/mo</span></div>
                    <ul>
                        <li>3 AI Articles per month</li>
                        <li>3 AI Images per month</li>
                        <li>1 Video Script per month</li>
                        <li>8 Keywords tracking</li>
                        <li>8 Daily Insights</li>
                    </ul>
                </div>

                <div class="tier-card">
                    <h3>Partner</h3>
                    <div class="price">$1,099<span style="font-size:18px">/mo</span></div>
                    <ul>
                        <li>6 AI Articles per month</li>
                        <li>6 AI Images per month</li>
                        <li>3 Video Scripts per month</li>
                        <li>15 Keywords tracking</li>
                        <li>12 Daily Insights</li>
                    </ul>
                </div>
            </div>

            <a href="/pricing" class="btn-upgrade">View Pricing & Upgrade</a>

            <div class="note">
                <strong>Note:</strong> Your brand data is still being collected for market insights and analysis.
                Upgrade to access AI content generation features.
            </div>
        </div>

        <!-- Content Studio (Paid Tiers) -->
        <div id="contentStudio" class="content-studio">
            <div id="quotaInfo" class="quota-info">
                <strong>Monthly Quota</strong>
                <div id="quotaText"></div>
                <div class="quota-bar">
                    <div id="quotaFill" class="quota-fill"></div>
                </div>
            </div>

            <div class="tabs">
                <button class="tab active" onclick="switchTab('article')">üìù Articles</button>
                <button class="tab" onclick="switchTab('image')">üñºÔ∏è Images</button>
                <button class="tab" onclick="switchTab('video')">üé¨ Videos</button>
                <button class="tab" onclick="switchTab('library')">üìö Library</button>
            </div>

            <!-- Article Generation -->
            <div id="articleTab" class="tab-content active">
                <h2 style="margin-bottom:24px">Generate AI Article</h2>
                <form id="articleForm" onsubmit="generateArticle(event)">
                    <div class="form-group">
                        <label>Article Topic *</label>
                        <input type="text" id="articleTopic" required placeholder="e.g., How to improve local SEO in 2026">
                    </div>

                    <div class="form-group">
                        <label>Keywords (comma-separated)</label>
                        <input type="text" id="articleKeywords" placeholder="SEO, local business, Google Maps">
                    </div>

                    <div class="form-group">
                        <label>Target Audience</label>
                        <input type="text" id="articleAudience" placeholder="Small business owners">
                    </div>

                    <div class="form-group">
                        <label>Target Platforms</label>
                        <div class="checkbox-group">
                            <label class="checkbox-label">
                                <input type="checkbox" name="platform" value="linkedin" checked> LinkedIn
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="platform" value="medium"> Medium
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="platform" value="blog"> Blog
                            </label>
                        </div>
                    </div>

                    <button type="submit" class="btn-generate" id="generateArticleBtn">Generate Article</button>
                </form>
            </div>

            <!-- Image Generation -->
            <div id="imageTab" class="tab-content">
                <h2 style="margin-bottom:24px">Generate AI Image</h2>
                <form id="imageForm" onsubmit="generateImage(event)">
                    <div class="form-group">
                        <label>Image Description *</label>
                        <textarea id="imagePrompt" required placeholder="e.g., Modern office space with people collaborating on laptops, bright natural lighting, professional atmosphere"></textarea>
                    </div>

                    <div class="form-group">
                        <label>Image Size</label>
                        <select id="imageSize">
                            <option value="1024x1024">Square (1024x1024) - Instagram, LinkedIn</option>
                            <option value="1792x1024">Landscape (1792x1024) - Blog headers</option>
                            <option value="1024x1792">Portrait (1024x1792) - Stories</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Target Platforms</label>
                        <div class="checkbox-group">
                            <label class="checkbox-label">
                                <input type="checkbox" name="imageplatform" value="instagram" checked> Instagram
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="imageplatform" value="linkedin"> LinkedIn
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="imageplatform" value="blog"> Blog
                            </label>
                        </div>
                    </div>

                    <button type="submit" class="btn-generate" id="generateImageBtn">Generate Image</button>
                </form>
            </div>

            <!-- Video Script Generation -->
            <div id="videoTab" class="tab-content">
                <h2 style="margin-bottom:24px">Generate Video Script</h2>
                <p style="color:#94a3b8;margin-bottom:24px">Available on Premium and Partner tiers only</p>
                <form id="videoForm" onsubmit="generateVideo(event)">
                    <div class="form-group">
                        <label>Video Topic *</label>
                        <input type="text" id="videoTopic" required placeholder="e.g., 3 Tips for Growing Your Local Business">
                    </div>

                    <div class="form-group">
                        <label>Video Duration</label>
                        <select id="videoDuration">
                            <option value="15">15 seconds (TikTok, Reels)</option>
                            <option value="30">30 seconds</option>
                            <option value="60" selected>60 seconds</option>
                            <option value="90">90 seconds</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Target Platform</label>
                        <select id="videoPlatform">
                            <option value="tiktok">TikTok</option>
                            <option value="instagram">Instagram Reels</option>
                            <option value="youtube">YouTube Shorts</option>
                        </select>
                    </div>

                    <button type="submit" class="btn-generate" id="generateVideoBtn">Generate Script</button>
                </form>
            </div>

            <!-- Content Library -->
            <div id="libraryTab" class="tab-content">
                <h2 style="margin-bottom:24px">Content Library</h2>
                <div id="contentLibrary" class="content-library">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Loading your content...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://vozjwptzutolvkvfpknk.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZvempWcHR6dXRvbHZrdmZwa25rIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzgxMzkzNjEsImV4cCI6MjA1MzcxNTM2MX0.WGfOPIeN4p7eo8-SBdHXWYKWLH5C6jOqg0xDGjpz8yk';

        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_KEY);

        let currentBrandId = null;
        let currentTier = null;

        async function checkAuth() {
            const { data: { user } } = await supabaseClient.auth.getUser();

            if (!user) {
                window.location.href = '/login';
                return false;
            }

            return user;
        }

        async function checkSubscriptionAccess() {
            const user = await checkAuth();
            if (!user) return;

            // Get user's brand
            const { data: userBrands } = await supabaseClient
                .from('user_brands')
                .select('brand_id, gv_brands(id, brand_name, subscription_tier)')
                .eq('user_id', user.id);

            if (!userBrands || userBrands.length === 0) {
                showAlert('No brand found. Please complete onboarding first.', 'error');
                setTimeout(() => window.location.href = '/onboarding', 2000);
                return;
            }

            const brand = userBrands[0].gv_brands;
            currentBrandId = brand.id;
            currentTier = brand.subscription_tier;

            // Check if free tier
            if (!currentTier || currentTier === 'free') {
                document.getElementById('upgradePrompt').classList.add('show');
                document.getElementById('contentStudio').classList.remove('show');
                return false;
            }

            // Show content studio
            document.getElementById('upgradePrompt').classList.remove('show');
            document.getElementById('contentStudio').classList.add('show');

            // Disable video tab for Basic tier
            if (currentTier === 'basic') {
                const videoTab = document.querySelector('.tab[onclick*="video"]');
                if (videoTab) {
                    videoTab.disabled = true;
                    videoTab.title = "Video generation requires Premium or Partner tier";
                    videoTab.style.opacity = "0.5";
                    videoTab.style.cursor = "not-allowed";
                    videoTab.style.pointerEvents = "none";
                }
            }

            // Load quota and library
            await loadQuota();
            await loadContentLibrary();

            return true;
        }

        async function loadQuota() {
            const { data, error } = await supabaseClient.rpc('get_content_quota_remaining', {
                p_brand_id: currentBrandId
            });

            if (error) {
                console.error('Failed to load quota:', error);
                showAlert('Could not load quota information', 'error');
                return;
            }

            if (data && data.length > 0) {
                const quota = data[0];
                const tierLimits = {
                    'basic': { articles: 1, images: 1, videos: 0 },
                    'premium': { articles: 3, images: 3, videos: 1 },
                    'partner': { articles: 6, images: 6, videos: 3 }
                };

                const limits = tierLimits[currentTier] || tierLimits.basic;
                const articlesUsed = limits.articles - quota.articles_remaining;
                const imagesUsed = limits.images - quota.images_remaining;
                const videosUsed = limits.videos - quota.videos_remaining;

                document.getElementById('quotaText').innerHTML = `
                    Articles: ${articlesUsed}/${limits.articles} |
                    Images: ${imagesUsed}/${limits.images} |
                    Videos: ${videosUsed}/${limits.videos}
                `;

                const totalUsed = articlesUsed + imagesUsed + videosUsed;
                const totalLimit = limits.articles + limits.images + limits.videos;
                const percentage = (totalUsed / totalLimit) * 100;
                document.getElementById('quotaFill').style.width = `${percentage}%`;
            }
        }

        async function loadContentLibrary() {
            const { data, error } = await supabaseClient
                .from('gv_content_library')
                .select('*')
                .eq('brand_id', currentBrandId)
                .order('created_at', { ascending: false });

            const library = document.getElementById('contentLibrary');

            if (error) {
                library.innerHTML = '<p style="color:#dc2626;text-align:center">Failed to load content library</p>';
                console.error('Library load error:', error);
                return;
            }

            if (!data || data.length === 0) {
                library.innerHTML = '<p style="text-align:center;color:#94a3b8">No content generated yet. Create your first piece above!</p>';
                return;
            }

            library.innerHTML = data.map(content => `
                <div class="content-card">
                    <h3>${content.title}</h3>
                    <div class="meta">
                        <span>${content.content_type.toUpperCase()}</span> ‚Ä¢
                        <span>${new Date(content.created_at).toLocaleDateString()}</span> ‚Ä¢
                        <span>$${content.generation_cost_usd}</span>
                    </div>
                    <div class="platforms">
                        ${content.target_platforms.map(p => `<span class="platform-tag">${p}</span>`).join('')}
                    </div>
                </div>
            `).join('');
        }

        async function generateArticle(e) {
            e.preventDefault();

            const btn = document.getElementById('generateArticleBtn');
            btn.disabled = true;
            btn.textContent = 'Generating...';

            try {
                const { data: { session } } = await supabaseClient.auth.getSession();
                const topic = document.getElementById('articleTopic').value;
                const keywords = document.getElementById('articleKeywords').value.split(',').map(k => k.trim()).filter(k => k);
                const audience = document.getElementById('articleAudience').value;
                const platforms = Array.from(document.querySelectorAll('input[name="platform"]:checked')).map(cb => cb.value);

                const response = await fetch(`${SUPABASE_URL}/functions/v1/generate-article`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${session.access_token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        brand_id: currentBrandId,
                        topic,
                        keywords,
                        target_audience: audience,
                        target_platforms: platforms
                    })
                });

                const result = await response.json();

                if (result.success) {
                    showAlert('Article generated successfully!', 'success');
                    await loadQuota();
                    await loadContentLibrary();
                    e.target.reset();
                } else {
                    showAlert(result.error || 'Failed to generate article', 'error');
                }
            } catch (error) {
                showAlert('Error: ' + error.message, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Generate Article';
            }
        }

        async function generateImage(e) {
            e.preventDefault();

            const btn = document.getElementById('generateImageBtn');
            btn.disabled = true;
            btn.textContent = 'Generating...';

            try {
                const { data: { session } } = await supabaseClient.auth.getSession();
                const prompt = document.getElementById('imagePrompt').value;
                const size = document.getElementById('imageSize').value;
                const platforms = Array.from(document.querySelectorAll('input[name="imageplatform"]:checked')).map(cb => cb.value);

                const response = await fetch(`${SUPABASE_URL}/functions/v1/generate-image`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${session.access_token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        brand_id: currentBrandId,
                        prompt,
                        size,
                        target_platforms: platforms
                    })
                });

                const result = await response.json();

                if (result.success) {
                    showAlert('Image generated successfully!', 'success');
                    await loadQuota();
                    await loadContentLibrary();
                    e.target.reset();
                } else {
                    showAlert(result.error || 'Failed to generate image', 'error');
                }
            } catch (error) {
                showAlert('Error: ' + error.message, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Generate Image';
            }
        }

        async function generateVideo(e) {
            e.preventDefault();

            if (currentTier === 'basic') {
                showAlert('Video generation requires Premium or Partner tier', 'error');
                return;
            }

            const btn = document.getElementById('generateVideoBtn');
            btn.disabled = true;
            btn.textContent = 'Generating...';

            try {
                const { data: { session } } = await supabaseClient.auth.getSession();
                const topic = document.getElementById('videoTopic').value;
                const duration = parseInt(document.getElementById('videoDuration').value);
                const platform = document.getElementById('videoPlatform').value;

                const response = await fetch(`${SUPABASE_URL}/functions/v1/generate-video`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${session.access_token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        brand_id: currentBrandId,
                        topic,
                        duration_seconds: duration,
                        target_platform: platform
                    })
                });

                const result = await response.json();

                if (result.success) {
                    showAlert('Video script generated successfully!', 'success');
                    await loadQuota();
                    await loadContentLibrary();
                    e.target.reset();
                } else {
                    showAlert(result.error || 'Failed to generate video script', 'error');
                }
            } catch (error) {
                showAlert('Error: ' + error.message, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Generate Script';
            }
        }

        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');

            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(tabName + 'Tab').classList.add('active');

            if (tabName === 'library') {
                loadContentLibrary();
            }
        }

        function showAlert(message, type) {
            const alert = document.getElementById('alert');
            alert.textContent = message;
            alert.className = `alert ${type} show`;
            setTimeout(() => alert.classList.remove('show'), 5000);
        }

        // Initialize on page load
        window.addEventListener('DOMContentLoaded', checkSubscriptionAccess);
    </script>
</body>
</html>
