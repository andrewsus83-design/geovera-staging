<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Onboarding - GeoVera</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 40px 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 40px 30px;
            text-align: center;
            color: white;
        }

        .header h1 {
            font-size: 32px;
            margin-bottom: 8px;
        }

        .header p {
            font-size: 14px;
            opacity: 0.9;
        }

        .progress-bar {
            display: flex;
            padding: 30px;
            gap: 10px;
        }

        .progress-step {
            flex: 1;
            height: 6px;
            background: #E5E7EB;
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-step.active {
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
        }

        .content {
            padding: 40px;
        }

        .step {
            display: none;
        }

        .step.active {
            display: block;
        }

        .step-title {
            font-size: 24px;
            margin-bottom: 8px;
            color: #111827;
        }

        .step-description {
            font-size: 14px;
            color: #6B7280;
            margin-bottom: 30px;
        }

        .field {
            margin-bottom: 24px;
        }

        label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #374151;
        }

        label .required {
            color: #EF4444;
        }

        label .optional {
            color: #9CA3AF;
            font-weight: 400;
            font-size: 13px;
        }

        input, select, textarea {
            width: 100%;
            padding: 14px;
            border: 2px solid #E5E7EB;
            border-radius: 10px;
            font-size: 15px;
            font-family: inherit;
            transition: all 0.3s;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        textarea {
            resize: vertical;
            min-height: 100px;
        }

        .radio-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
        }

        .radio-option {
            position: relative;
        }

        .radio-option input[type="radio"] {
            position: absolute;
            opacity: 0;
        }

        .radio-option label {
            display: block;
            padding: 16px;
            border: 2px solid #E5E7EB;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .radio-option input[type="radio"]:checked + label {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.05);
        }

        .tier-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .tier-card {
            border: 2px solid #E5E7EB;
            border-radius: 12px;
            padding: 24px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .tier-card input[type="radio"] {
            position: absolute;
            opacity: 0;
        }

        .tier-card:hover {
            border-color: #667eea;
            transform: translateY(-4px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.1);
        }

        .tier-card input[type="radio"]:checked ~ .tier-content {
            color: #667eea;
        }

        .tier-card input[type="radio"]:checked ~ .tier-content::after {
            content: '‚úì';
            position: absolute;
            top: 12px;
            right: 12px;
            width: 24px;
            height: 24px;
            background: #667eea;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }

        .tier-name {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .tier-price {
            font-size: 28px;
            font-weight: 700;
            color: #111827;
            margin-bottom: 4px;
        }

        .tier-price span {
            font-size: 14px;
            color: #6B7280;
            font-weight: 400;
        }

        .tier-savings {
            font-size: 12px;
            color: #10B981;
            font-weight: 600;
            margin-bottom: 16px;
            min-height: 18px;
        }

        .tier-features {
            font-size: 13px;
            color: #6B7280;
            line-height: 1.6;
        }

        .billing-toggle {
            display: flex;
            gap: 12px;
            align-items: center;
            justify-content: center;
            margin-bottom: 24px;
        }

        .billing-toggle label {
            font-size: 15px;
            margin: 0;
        }

        .toggle-switch {
            position: relative;
            width: 50px;
            height: 26px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #E5E7EB;
            transition: 0.4s;
            border-radius: 26px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: 0.4s;
            border-radius: 50%;
        }

        .toggle-switch input:checked + .toggle-slider {
            background-color: #10B981;
        }

        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(24px);
        }

        .confirm-box {
            background: #FEF3C7;
            border: 2px solid #F59E0B;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
        }

        .confirm-box h3 {
            font-size: 18px;
            color: #92400E;
            margin-bottom: 12px;
        }

        .confirm-box p {
            font-size: 14px;
            color: #78350F;
            line-height: 1.6;
            margin-bottom: 16px;
        }

        .confirm-box ul {
            margin-left: 20px;
            margin-bottom: 16px;
        }

        .confirm-box li {
            font-size: 14px;
            color: #78350F;
            margin-bottom: 8px;
        }

        .confirm-input-wrapper {
            margin-top: 20px;
        }

        .confirm-input-wrapper input {
            border-color: #F59E0B;
        }

        .message {
            padding: 14px;
            margin-bottom: 20px;
            border-radius: 10px;
            font-size: 14px;
            display: none;
        }

        .message.error {
            background: #FEE2E2;
            border: 1px solid #EF4444;
            color: #991B1B;
        }

        .message.success {
            background: #D1FAE5;
            border: 1px solid #10B981;
            color: #065F46;
        }

        .message.show {
            display: block;
        }

        .actions {
            display: flex;
            gap: 12px;
            margin-top: 30px;
        }

        .actions button {
            flex: 1;
            padding: 16px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        button.secondary {
            background: #F3F4F6;
            color: #374151;
        }

        button.secondary:hover {
            background: #E5E7EB;
        }

        button.primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        button.primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        .help-text {
            font-size: 13px;
            color: #6B7280;
            margin-top: 6px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ Welcome to GeoVera</h1>
            <p>Let's set up your brand in 3 easy steps</p>
        </div>

        <div class="progress-bar">
            <div class="progress-step active" data-step="1"></div>
            <div class="progress-step" data-step="2"></div>
            <div class="progress-step" data-step="3"></div>
        </div>

        <div class="content">
            <div id="message" class="message"></div>

            <!-- STEP 1: Brand Information + Tier Selection -->
            <div class="step active" data-step="1">
                <h2 class="step-title">Step 1: Brand Information</h2>
                <p class="step-description">Tell us about your brand and select your subscription plan</p>

                <form id="step1-form">
                    <div class="field">
                        <label>Brand Name <span class="required">*</span></label>
                        <input type="text" name="brand_name" required minlength="2" placeholder="Enter your brand name">
                    </div>

                    <div class="field">
                        <label>Category <span class="required">*</span></label>
                        <select name="category" required>
                            <option value="">Select a category</option>
                            <option value="agency">Agency</option>
                            <option value="beauty">Beauty</option>
                            <option value="car_motorcycle">Car & Motorcycle</option>
                            <option value="consultant">Consultant</option>
                            <option value="contractor">Contractor</option>
                            <option value="ecommerce">E-Commerce</option>
                            <option value="education">Education</option>
                            <option value="event_organizer">Event Organizer</option>
                            <option value="fashion">Fashion</option>
                            <option value="finance">Finance</option>
                            <option value="fmcg">FMCG</option>
                            <option value="fnb">Food & Beverage</option>
                            <option value="health">Health & Wellness</option>
                            <option value="lifestyle">Lifestyle</option>
                            <option value="mom_baby">Mom & Baby</option>
                            <option value="other">Other</option>
                            <option value="photo_video">Photo & Video</option>
                            <option value="saas">SaaS</option>
                        </select>
                    </div>

                    <div class="field">
                        <label>Business Type <span class="required">*</span></label>
                        <div class="radio-group">
                            <div class="radio-option">
                                <input type="radio" id="online" name="business_type" value="online" required>
                                <label for="online">üåê Online</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="offline" name="business_type" value="offline">
                                <label for="offline">üè™ Offline</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="hybrid" name="business_type" value="hybrid">
                                <label for="hybrid">üîÑ Hybrid</label>
                            </div>
                        </div>
                    </div>

                    <div class="field" id="gmaps-field" style="display: none;">
                        <label>Google Maps URL <span class="required">*</span></label>
                        <input type="url" name="google_maps_url" placeholder="https://maps.google.com/...">
                        <p class="help-text">Required for offline/hybrid businesses</p>
                    </div>

                    <div class="field">
                        <label>Country <span class="required">*</span></label>
                        <select name="country" required>
                            <option value="">Select a country</option>
                            <option value="ID">üáÆüá© Indonesia</option>
                            <option value="US">üá∫üá∏ United States</option>
                            <option value="SG">üá∏üá¨ Singapore</option>
                            <option value="MY">üá≤üáæ Malaysia</option>
                            <option value="TH">üáπüá≠ Thailand</option>
                            <option value="PH">üáµüá≠ Philippines</option>
                            <option value="VN">üáªüá≥ Vietnam</option>
                            <option value="AU">üá¶üá∫ Australia</option>
                            <option value="GB">üá¨üáß United Kingdom</option>
                        </select>
                    </div>

                    <div class="field">
                        <label>Description <span class="optional">(optional)</span></label>
                        <textarea name="description" placeholder="Tell us about your brand..."></textarea>
                    </div>

                    <hr style="margin: 40px 0; border: none; border-top: 2px solid #E5E7EB;">

                    <h3 style="font-size: 20px; margin-bottom: 20px; text-align: center;">Select Your Plan</h3>

                    <div class="billing-toggle">
                        <label>Monthly</label>
                        <label class="toggle-switch">
                            <input type="checkbox" id="billing-toggle">
                            <span class="toggle-slider"></span>
                        </label>
                        <label style="color: #10B981;">Yearly <small>(Save 1 month!)</small></label>
                    </div>

                    <div class="tier-cards">
                        <label class="tier-card">
                            <input type="radio" name="tier" value="basic" required>
                            <div class="tier-content">
                                <div class="tier-name">Basic</div>
                                <div class="tier-price monthly">$399<span>/mo</span></div>
                                <div class="tier-price yearly" style="display: none;">$4,389<span>/yr</span></div>
                                <div class="tier-savings yearly" style="display: none;">Save $399/year!</div>
                                <div class="tier-savings monthly">&nbsp;</div>
                                <div class="tier-features">
                                    ‚Ä¢ 5 daily insights<br>
                                    ‚Ä¢ Limited content<br>
                                    ‚Ä¢ Email support
                                </div>
                            </div>
                        </label>

                        <label class="tier-card" style="transform: scale(1.05); border-color: #667eea;">
                            <input type="radio" name="tier" value="premium" checked>
                            <div class="tier-content">
                                <div class="tier-name" style="color: #667eea;">Premium ‚≠ê</div>
                                <div class="tier-price monthly">$699<span>/mo</span></div>
                                <div class="tier-price yearly" style="display: none;">$7,689<span>/yr</span></div>
                                <div class="tier-savings yearly" style="display: none;">Save $699/year!</div>
                                <div class="tier-savings monthly">&nbsp;</div>
                                <div class="tier-features">
                                    ‚Ä¢ 15 daily insights<br>
                                    ‚Ä¢ Unlimited content<br>
                                    ‚Ä¢ Priority support
                                </div>
                            </div>
                        </label>

                        <label class="tier-card">
                            <input type="radio" name="tier" value="partner">
                            <div class="tier-content">
                                <div class="tier-name">Partner</div>
                                <div class="tier-price monthly">$1,099<span>/mo</span></div>
                                <div class="tier-price yearly" style="display: none;">$12,089<span>/yr</span></div>
                                <div class="tier-savings yearly" style="display: none;">Save $1,099/year!</div>
                                <div class="tier-savings monthly">&nbsp;</div>
                                <div class="tier-features">
                                    ‚Ä¢ Unlimited insights<br>
                                    ‚Ä¢ White-label option<br>
                                    ‚Ä¢ Dedicated support
                                </div>
                            </div>
                        </label>
                    </div>

                    <div class="actions">
                        <button type="submit" class="primary">Continue to Step 2 ‚Üí</button>
                    </div>
                </form>
            </div>

            <!-- STEP 2: Social Media Links -->
            <div class="step" data-step="2">
                <h2 class="step-title">Step 2: Social Media Links</h2>
                <p class="step-description">Connect your social media accounts (all optional)</p>

                <form id="step2-form">
                    <div class="field">
                        <label>Website URL <span class="optional">(optional)</span></label>
                        <input type="url" name="web_url" placeholder="https://yourwebsite.com">
                    </div>

                    <div class="field">
                        <label>WhatsApp <span class="optional">(optional)</span></label>
                        <input type="tel" name="whatsapp" placeholder="+628123456789">
                        <p class="help-text">Include country code (e.g., +62)</p>
                    </div>

                    <div class="field">
                        <label>Instagram URL <span class="optional">(optional)</span></label>
                        <input type="url" name="instagram_url" placeholder="https://instagram.com/yourbrand">
                    </div>

                    <div class="field">
                        <label>TikTok URL <span class="optional">(optional)</span></label>
                        <input type="url" name="tiktok_url" placeholder="https://tiktok.com/@yourbrand">
                    </div>

                    <div class="field">
                        <label>YouTube URL <span class="optional">(optional)</span></label>
                        <input type="url" name="youtube_url" placeholder="https://youtube.com/@yourbrand">
                    </div>

                    <div class="actions">
                        <button type="button" class="secondary" id="back-to-step1">‚Üê Back</button>
                        <button type="submit" class="primary">Continue to Confirmation ‚Üí</button>
                    </div>
                </form>
            </div>

            <!-- STEP 3: Confirmation -->
            <div class="step" data-step="3">
                <h2 class="step-title">Step 3: Confirm Your Brand</h2>
                <p class="step-description">Review your details and confirm to complete setup</p>

                <div class="confirm-box">
                    <h3>‚ö†Ô∏è Important: Brand Lock Policy</h3>
                    <p><strong>Your brand will be locked for 30 days after creation.</strong></p>
                    <p>This is because we will personalize:</p>
                    <ul>
                        <li>Brand DNA analysis based on your industry</li>
                        <li>Competitor research specific to your brand</li>
                        <li>Custom content recommendations</li>
                        <li>Market positioning insights</li>
                    </ul>
                    <p><strong>You will receive an email report containing:</strong></p>
                    <ul>
                        <li>üìä Brand DNA analysis</li>
                        <li>üìÖ Brand Chronicle (timeline)</li>
                        <li>üí° Daily Insights (1-2 samples)</li>
                        <li>‚úÖ Recommended To-Do list</li>
                        <li>üìù Generated content samples</li>
                        <li>üéØ Radar & Authority Hub preview</li>
                    </ul>

                    <div class="confirm-input-wrapper">
                        <label>Type "SAYA SETUJU" to confirm you understand <span class="required">*</span></label>
                        <input type="text" id="confirm-text" placeholder="SAYA SETUJU" required style="text-transform: uppercase;">
                    </div>
                </div>

                <form id="step3-form">
                    <div class="field" style="margin-bottom: 0;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" id="confirm-lock" required style="width: auto;">
                            <span>I understand that my brand cannot be changed for 30 days</span>
                        </label>
                    </div>

                    <div class="actions">
                        <button type="button" class="secondary" id="back-to-step2">‚Üê Back</button>
                        <button type="submit" class="primary">üéâ Complete Setup</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        console.log('[GeoVera] Onboarding page loaded');

        const SUPABASE_URL = 'https://vozjwptzutolvkvfpknk.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZvemp3cHR6dXRvbHZrdmZwa25rIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk4ODI0NzcsImV4cCI6MjA4NTQ1ODQ3N30.p-RiTR1Iva9Y4KiZu8gnF2CZjvnMWNAHUVCbp57PDF8';

        let currentStep = 1;
        let brandId = null;
        let brandData = {};

        // Get auth token
        const accessToken = localStorage.getItem('access_token');
        if (!accessToken) {
            window.location.href = '/login-complete.html';
        }

        // Show/hide Google Maps field based on business type
        document.querySelectorAll('input[name="business_type"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                const gmapsField = document.getElementById('gmaps-field');
                const gmapsInput = gmapsField.querySelector('input');

                if (e.target.value === 'offline' || e.target.value === 'hybrid') {
                    gmapsField.style.display = 'block';
                    gmapsInput.required = true;
                } else {
                    gmapsField.style.display = 'none';
                    gmapsInput.required = false;
                    gmapsInput.value = '';
                }
            });
        });

        // Billing toggle
        const billingToggle = document.getElementById('billing-toggle');
        billingToggle.addEventListener('change', (e) => {
            const isYearly = e.target.checked;
            document.querySelectorAll('.tier-price.monthly').forEach(el => {
                el.style.display = isYearly ? 'none' : 'block';
            });
            document.querySelectorAll('.tier-price.yearly').forEach(el => {
                el.style.display = isYearly ? 'block' : 'none';
            });
            document.querySelectorAll('.tier-savings.monthly').forEach(el => {
                el.style.display = isYearly ? 'none' : 'block';
            });
            document.querySelectorAll('.tier-savings.yearly').forEach(el => {
                el.style.display = isYearly ? 'block' : 'none';
            });
        });

        function showMessage(text, type) {
            const msg = document.getElementById('message');
            msg.textContent = text;
            msg.className = 'message ' + type + ' show';
            msg.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        function goToStep(step) {
            currentStep = step;
            document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
            document.querySelector(`.step[data-step="${step}"]`).classList.add('active');

            document.querySelectorAll('.progress-step').forEach((s, i) => {
                s.classList.toggle('active', i < step);
            });

            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Step 1
        document.getElementById('step1-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const submitBtn = e.target.querySelector('button[type="submit"]');

            const data = {
                step: 1,
                brand_name: formData.get('brand_name'),
                category: formData.get('category'),
                business_type: formData.get('business_type'),
                country: formData.get('country'),
                google_maps_url: formData.get('google_maps_url') || null,
                description: formData.get('description') || null,
                tier: formData.get('tier'),
                billing_cycle: billingToggle.checked ? 'yearly' : 'monthly',
            };

            submitBtn.textContent = 'Creating brand...';
            submitBtn.disabled = true;

            try {
                const response = await fetch(`${SUPABASE_URL}/functions/v1/onboard-brand-v3`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${accessToken}`,
                        'apikey': SUPABASE_ANON_KEY,
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                console.log('[Step 1] Response:', result);

                if (response.ok && result.success) {
                    brandId = result.brand_id;
                    brandData = result.brand;
                    showMessage('‚úÖ ' + result.message, 'success');
                    goToStep(2);
                } else {
                    showMessage('‚ùå ' + (result.error || 'Failed to create brand'), 'error');
                    if (result.details) {
                        console.error('Errors:', result.details);
                    }
                }
            } catch (error) {
                console.error('[Step 1] Error:', error);
                showMessage('‚ùå Network error. Please try again.', 'error');
            } finally {
                submitBtn.textContent = 'Continue to Step 2 ‚Üí';
                submitBtn.disabled = false;
            }
        });

        // Step 2
        document.getElementById('step2-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const submitBtn = e.target.querySelector('button[type="submit"]');

            const data = {
                step: 2,
                brand_id: brandId,
                web_url: formData.get('web_url') || null,
                whatsapp: formData.get('whatsapp') || null,
                instagram_url: formData.get('instagram_url') || null,
                tiktok_url: formData.get('tiktok_url') || null,
                youtube_url: formData.get('youtube_url') || null,
            };

            submitBtn.textContent = 'Saving...';
            submitBtn.disabled = true;

            try {
                const response = await fetch(`${SUPABASE_URL}/functions/v1/onboard-brand-v3`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${accessToken}`,
                        'apikey': SUPABASE_ANON_KEY,
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                console.log('[Step 2] Response:', result);

                if (response.ok && result.success) {
                    brandData = result.brand;
                    showMessage('‚úÖ ' + result.message, 'success');
                    goToStep(3);
                } else {
                    showMessage('‚ùå ' + (result.error || 'Failed to save social links'), 'error');
                }
            } catch (error) {
                console.error('[Step 2] Error:', error);
                showMessage('‚ùå Network error. Please try again.', 'error');
            } finally {
                submitBtn.textContent = 'Continue to Confirmation ‚Üí';
                submitBtn.disabled = false;
            }
        });

        // Step 3
        document.getElementById('step3-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const confirmText = document.getElementById('confirm-text').value.trim().toUpperCase();
            const confirmLock = document.getElementById('confirm-lock').checked;
            const submitBtn = e.target.querySelector('button[type="submit"]');

            if (confirmText !== 'SAYA SETUJU') {
                showMessage('‚ùå Please type "SAYA SETUJU" to confirm', 'error');
                return;
            }

            if (!confirmLock) {
                showMessage('‚ùå Please confirm you understand the 30-day lock', 'error');
                return;
            }

            const data = {
                step: 3,
                brand_id: brandId,
                understood_30day_lock: true,
                confirmation_text: confirmText,
            };

            submitBtn.textContent = 'Completing setup...';
            submitBtn.disabled = true;

            try {
                const response = await fetch(`${SUPABASE_URL}/functions/v1/onboard-brand-v3`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${accessToken}`,
                        'apikey': SUPABASE_ANON_KEY,
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                console.log('[Step 3] Response:', result);

                if (response.ok && result.success) {
                    showMessage('üéâ ' + result.message, 'success');
                    setTimeout(() => {
                        window.location.href = '/dashboard.html';
                    }, 2000);
                } else {
                    showMessage('‚ùå ' + (result.error || 'Failed to complete onboarding'), 'error');
                }
            } catch (error) {
                console.error('[Step 3] Error:', error);
                showMessage('‚ùå Network error. Please try again.', 'error');
            } finally {
                submitBtn.textContent = 'üéâ Complete Setup';
                submitBtn.disabled = false;
            }
        });

        // Back buttons
        document.getElementById('back-to-step1').addEventListener('click', () => goToStep(1));
        document.getElementById('back-to-step2').addEventListener('click', () => goToStep(2));

        console.log('[GeoVera] Onboarding ready');
    </script>
</body>
</html>
