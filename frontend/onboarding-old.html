<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Brand Onboarding - GeoVera</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="env.js"></script>
    <script src="env-loader.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');

    :root {
      /* WIRED Design System Colors */
      --gv-hero: #16A34A;
      --gv-anchor: #0B0F19;
      --gv-body: #6B7280;
      --gv-canvas: #FFFFFF;
      --gv-secondary: #2563EB;
      --gv-risk: #DC2626;
      --gv-divider: #E5E7EB;
      --gv-bg-light: #F9FAFB;

      /* Typography */
      --font-display: Georgia, 'Times New Roman', serif;
      --font-body: 'Inter', system-ui, -apple-system, sans-serif;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
      position: fixed;
      overscroll-behavior: none;
    }

    body {
      font-family: var(--font-body);
      background: var(--gv-bg-light);
      font-size: 18px;
      line-height: 1.53;
    }

    .scroll-container {
      width: 100%;
      height: 100vh;
      overflow-y: auto;
      overflow-x: hidden;
      -webkit-overflow-scrolling: touch;
      overscroll-behavior: contain;
    }

    .typeform-container {
      height: 100vh;
      width: 100vw;
      background: var(--gv-canvas);
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      overflow: auto;
      border-top: 4px solid var(--gv-hero);
    }

    .typeform-step {
      width: 100%;
      height: 100%;
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 2rem;
      animation: fadeSlideIn 0.6s cubic-bezier(0.165, 0.84, 0.44, 1);
    }

    .typeform-step.active {
      display: flex;
    }

    @keyframes fadeSlideIn {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .question-number {
      color: var(--gv-body);
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 1rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
    }

    .question-title {
      color: var(--gv-anchor);
      font-family: var(--font-display);
      font-size: 2.5rem;
      font-weight: 700;
      margin-bottom: 2rem;
      text-align: center;
      line-height: 1.2;
      max-width: 800px;
    }

    .input-container {
      width: 100%;
      max-width: 600px;
      margin-bottom: 2rem;
    }

    .typeform-input, .typeform-select, .typeform-textarea {
      width: 100%;
      padding: 1.25rem;
      font-size: 1.25rem;
      border: 2px solid var(--gv-divider);
      background: white;
      border-radius: 0;
      outline: none;
      transition: all 0.2s ease;
      font-family: var(--font-body);
      color: var(--gv-anchor);
    }

    .typeform-input:focus, .typeform-select:focus, .typeform-textarea:focus {
      border-color: var(--gv-hero);
    }

    .typeform-textarea {
      min-height: 150px;
      font-size: 1.1rem;
      resize: vertical;
    }

    .btn-continue {
      background: var(--gv-hero);
      color: white;
      padding: 1rem 2.5rem;
      font-size: 1rem;
      font-weight: 600;
      border: none;
      border-radius: 0;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      font-family: var(--font-body);
    }

    .btn-continue:hover {
      background: #15803d;
    }

    .btn-back {
      background: white;
      color: var(--gv-anchor);
      border: 2px solid var(--gv-divider);
      padding: 0.75rem 2rem;
      font-size: 0.9rem;
      font-weight: 600;
      border-radius: 0;
      cursor: pointer;
      transition: all 0.2s ease;
      margin-right: 1rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      font-family: var(--font-body);
    }

    .btn-back:hover {
      border-color: var(--gv-anchor);
    }

    .progress-indicator {
      position: fixed;
      bottom: 2rem;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 0.5rem;
      z-index: 1000;
    }

    .progress-dot {
      width: 12px;
      height: 12px;
      border-radius: 0;
      background: var(--gv-divider);
      transition: all 0.3s ease;
    }

    .progress-dot.active {
      background: var(--gv-hero);
      width: 32px;
    }

    .spinner {
      border: 4px solid var(--gv-divider);
      border-top: 4px solid var(--gv-hero);
      border-radius: 50%;
      width: 60px;
      height: 60px;
      animation: spin 1s linear infinite;
      margin: 0 auto 2rem;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .warning-box {
      background: white;
      padding: 2rem;
      border-radius: 0;
      max-width: 700px;
      margin-bottom: 2rem;
      border: 3px solid #f59e0b;
    }

    .review-item {
      background: white;
      padding: 1.5rem;
      border-radius: 0;
      margin-bottom: 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border: 2px solid var(--gv-divider);
    }

    .badge {
      padding: 0.5rem 1rem;
      border-radius: 0;
      font-size: 0.75rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .badge-locked {
      background: var(--gv-risk);
      color: white;
    }

    .badge-editable {
      background: var(--gv-hero);
      color: white;
    }

    .success-icon {
      font-size: 6rem;
      margin-bottom: 2rem;
    }

    .email-card {
      background: white;
      padding: 2.5rem;
      border-radius: 0;
      max-width: 700px;
      text-align: center;
      margin-bottom: 2rem;
      border: 2px solid var(--gv-divider);
    }

    .hint-text {
      color: var(--gv-body);
      font-size: 0.95rem;
      margin-top: 1rem;
      text-align: center;
    }

    .press-enter {
      color: var(--gv-body);
      font-size: 0.85rem;
      margin-top: 1rem;
      text-align: center;
    }
  </style>
</head>
<body>

  <div class="scroll-container">
  <div class="typeform-container">

    <!-- Progress Indicator -->
    <div class="progress-indicator">
      <div class="progress-dot active" data-step="1"></div>
      <div class="progress-dot" data-step="2"></div>
      <div class="progress-dot" data-step="3"></div>
      <div class="progress-dot" data-step="4"></div>
    </div>

    <!-- STEP 1: Brand Name -->
    <div class="typeform-step active" id="step-1">
      <div class="question-number">1 â†’ 4</div>
      <h1 class="question-title">What's your brand name? âœ¨</h1>
      <div class="input-container">
        <input
          type="text"
          id="brand_name"
          class="typeform-input"
          placeholder="Type your answer here..."
          autocomplete="off"
        >
      </div>
      <button type="button" onclick="validateAndContinue(1)" class="btn-continue">
        OK âœ“
      </button>
      <div class="press-enter">press Enter â†µ</div>
    </div>

    <!-- STEP 2: Category -->
    <div class="typeform-step" id="step-2a">
      <div class="question-number">2 â†’ 4</div>
      <h1 class="question-title">What category is your brand in? ğŸ·ï¸</h1>
      <div class="input-container">
        <select id="category" class="typeform-select">
          <option value="">Choose one...</option>
          <option value="Fashion & Apparel">Fashion & Apparel</option>
          <option value="Technology">Technology</option>
          <option value="Food & Beverage">Food & Beverage</option>
          <option value="Beauty & Cosmetics">Beauty & Cosmetics</option>
          <option value="Sports & Fitness">Sports & Fitness</option>
          <option value="Home & Living">Home & Living</option>
          <option value="Health & Wellness">Health & Wellness</option>
          <option value="Entertainment">Entertainment</option>
          <option value="Education">Education</option>
          <option value="Other">Other</option>
        </select>
      </div>
      <div style="display: flex; align-items: center;">
        <button type="button" onclick="goBack()" class="btn-back">â† Back</button>
        <button type="button" onclick="validateAndContinue(2)" class="btn-continue">OK âœ“</button>
      </div>
    </div>

    <!-- STEP 3: Country -->
    <div class="typeform-step" id="step-2b">
      <div class="question-number">2 â†’ 4</div>
      <h1 class="question-title">Which country is your brand based in? ğŸŒ</h1>
      <div class="input-container">
        <select id="country" class="typeform-select">
          <option value="">Choose one...</option>
          <option value="Indonesia">ğŸ‡®ğŸ‡© Indonesia</option>
          <option value="Singapore">ğŸ‡¸ğŸ‡¬ Singapore</option>
          <option value="Malaysia">ğŸ‡²ğŸ‡¾ Malaysia</option>
          <option value="Thailand">ğŸ‡¹ğŸ‡­ Thailand</option>
          <option value="Philippines">ğŸ‡µğŸ‡­ Philippines</option>
          <option value="Vietnam">ğŸ‡»ğŸ‡³ Vietnam</option>
          <option value="United States">ğŸ‡ºğŸ‡¸ United States</option>
          <option value="United Kingdom">ğŸ‡¬ğŸ‡§ United Kingdom</option>
          <option value="Australia">ğŸ‡¦ğŸ‡º Australia</option>
          <option value="Other">ğŸŒ Other</option>
        </select>
      </div>
      <div style="display: flex; align-items: center;">
        <button type="button" onclick="goBack()" class="btn-back">â† Back</button>
        <button type="button" onclick="validateAndContinue(3)" class="btn-continue">OK âœ“</button>
      </div>
    </div>

    <!-- STEP 4: Description -->
    <div class="typeform-step" id="step-2c">
      <div class="question-number">2 â†’ 4</div>
      <h1 class="question-title">Tell us about your brand ğŸ“</h1>
      <div class="input-container">
        <textarea
          id="description"
          class="typeform-textarea"
          placeholder="What makes your brand unique? What do you offer?"
        ></textarea>
      </div>
      <div style="display: flex; align-items: center;">
        <button type="button" onclick="goBack()" class="btn-back">â† Back</button>
        <button type="button" onclick="validateAndContinue(4)" class="btn-continue">OK âœ“</button>
      </div>
    </div>

    <!-- STEP 5: Website URL -->
    <div class="typeform-step" id="step-2d">
      <div class="question-number">2 â†’ 4</div>
      <h1 class="question-title">What's your website URL? ğŸŒ</h1>
      <div class="input-container">
        <input
          type="url"
          id="website_url"
          class="typeform-input"
          placeholder="https://yourbrand.com"
          autocomplete="off"
        >
      </div>
      <div class="hint-text">Optional - press Enter to skip</div>
      <div style="display: flex; align-items: center;">
        <button type="button" onclick="goBack()" class="btn-back">â† Back</button>
        <button type="button" onclick="validateAndContinue(5)" class="btn-continue">OK âœ“</button>
      </div>
    </div>

    <!-- STEP 6: Instagram URL -->
    <div class="typeform-step" id="step-2e">
      <div class="question-number">2 â†’ 4</div>
      <h1 class="question-title">Instagram URL? ğŸ“¸</h1>
      <div class="input-container">
        <input
          type="url"
          id="instagram_url"
          class="typeform-input"
          placeholder="https://instagram.com/yourbrand"
          autocomplete="off"
        >
      </div>
      <div class="hint-text">Optional - press Enter to skip</div>
      <div style="display: flex; align-items: center;">
        <button type="button" onclick="goBack()" class="btn-back">â† Back</button>
        <button type="button" onclick="validateAndContinue(6)" class="btn-continue">OK âœ“</button>
      </div>
    </div>

    <!-- STEP 7: TikTok URL -->
    <div class="typeform-step" id="step-2f">
      <div class="question-number">2 â†’ 4</div>
      <h1 class="question-title">TikTok URL? ğŸµ</h1>
      <div class="input-container">
        <input
          type="url"
          id="tiktok_url"
          class="typeform-input"
          placeholder="https://tiktok.com/@yourbrand"
          autocomplete="off"
        >
      </div>
      <div class="hint-text">Optional - press Enter to skip</div>
      <div style="display: flex; align-items: center;">
        <button type="button" onclick="goBack()" class="btn-back">â† Back</button>
        <button type="button" onclick="validateAndContinue(7)" class="btn-continue">OK âœ“</button>
      </div>
    </div>

    <!-- STEP 8: YouTube URL -->
    <div class="typeform-step" id="step-2g">
      <div class="question-number">2 â†’ 4</div>
      <h1 class="question-title">YouTube URL? ğŸ“¹</h1>
      <div class="input-container">
        <input
          type="url"
          id="youtube_url"
          class="typeform-input"
          placeholder="https://youtube.com/@yourbrand"
          autocomplete="off"
        >
      </div>
      <div class="hint-text">Optional - press Enter to skip</div>
      <div style="display: flex; align-items: center;">
        <button type="button" onclick="goBack()" class="btn-back">â† Back</button>
        <button type="button" onclick="validateAndContinue(8)" class="btn-continue">OK âœ“</button>
      </div>
    </div>

    <!-- STEP 9: WhatsApp Number -->
    <div class="typeform-step" id="step-2h">
      <div class="question-number">2 â†’ 4</div>
      <h1 class="question-title">WhatsApp number? ğŸ’¬</h1>
      <div class="input-container">
        <input
          type="tel"
          id="whatsapp_number"
          class="typeform-input"
          placeholder="+62812345678"
          autocomplete="off"
        >
      </div>
      <div class="hint-text">Optional - press Enter to skip</div>
      <div style="display: flex; align-items: center;">
        <button type="button" onclick="goBack()" class="btn-back">â† Back</button>
        <button type="button" onclick="submitStep2()" class="btn-continue">Continue â†’</button>
      </div>
    </div>

    <!-- STEP 10: Review & Warning -->
    <div class="typeform-step" id="step-3">
      <div class="question-number">3 â†’ 4</div>
      <h1 class="question-title">âš ï¸ Final Confirmation</h1>

      <div class="warning-box">
        <h3 style="font-size: 1.5rem; font-weight: 700; color: #f59e0b; margin-bottom: 1rem;">
          ğŸ”’ IMPORTANT: Brand Lock Notice
        </h3>
        <p style="color: #78350f; margin-bottom: 1rem; font-size: 1.1rem;">
          Once you confirm, these fields will be <strong>LOCKED for 30 days</strong>:
        </p>
        <ul style="list-style: none; padding: 0; margin-bottom: 1.5rem;">
          <li style="padding: 0.5rem 0; color: #78350f; font-weight: 600;">ğŸ”’ Brand Name</li>
          <li style="padding: 0.5rem 0; color: #78350f; font-weight: 600;">ğŸ”’ Category</li>
          <li style="padding: 0.5rem 0; color: #78350f; font-weight: 600;">ğŸ”’ Country</li>
        </ul>
        <p style="color: #15803d; font-weight: 600; font-size: 1.1rem;">
          âœï¸ You CAN still edit: URLs, Description, Contact Info
        </p>
      </div>

      <div style="max-width: 700px; width: 100%; margin-bottom: 2rem;">
        <div class="review-item">
          <div>
            <div style="font-size: 0.85rem; color: #6b7280; margin-bottom: 0.25rem;">Brand Name</div>
            <div style="font-size: 1.25rem; font-weight: 700; color: #1f2937;" id="review-brand-name"></div>
          </div>
          <div class="badge badge-locked">LOCKED</div>
        </div>

        <div class="review-item">
          <div>
            <div style="font-size: 0.85rem; color: #6b7280; margin-bottom: 0.25rem;">Category</div>
            <div style="font-size: 1.25rem; font-weight: 700; color: #1f2937;" id="review-category"></div>
          </div>
          <div class="badge badge-locked">LOCKED</div>
        </div>

        <div class="review-item">
          <div>
            <div style="font-size: 0.85rem; color: #6b7280; margin-bottom: 0.25rem;">Country</div>
            <div style="font-size: 1.25rem; font-weight: 700; color: #1f2937;" id="review-country"></div>
          </div>
          <div class="badge badge-locked">LOCKED</div>
        </div>
      </div>

      <div style="display: flex; align-items: center;">
        <button type="button" onclick="goBack()" class="btn-back">â† Back</button>
        <button type="button" onclick="confirmAndLock()" class="btn-continue" style="background: var(--gv-risk);">
          I Understand - Lock My Brand
        </button>
      </div>
    </div>

    <!-- STEP 11: Processing -->
    <div class="typeform-step" id="step-processing">
      <div class="spinner"></div>
      <h1 class="question-title">Processing your brand data... ğŸš€</h1>
      <p class="hint-text" style="font-size: 1.25rem;">This will take a few moments</p>
    </div>

    <!-- STEP 12: Email Sent & CTA -->
    <div class="typeform-step" id="step-4">
      <div class="success-icon">ğŸ“§</div>
      <h1 class="question-title">Check Your Email!</h1>

      <div class="email-card">
        <p style="font-size: 1.25rem; color: #6b7280; margin-bottom: 1rem;">
          We've sent your <strong>Brand DNA</strong> and <strong>FREE Report</strong> to:
        </p>
        <p style="font-size: 2rem; font-weight: 700; color: #667eea; margin-bottom: 2rem;" id="user-email"></p>

        <div style="text-align: left; margin-bottom: 2rem;">
          <div style="margin-bottom: 1rem; display: flex; align-items: start;">
            <span style="font-size: 2rem; margin-right: 1rem;">ğŸ§¬</span>
            <div>
              <div style="font-weight: 700; font-size: 1.1rem; margin-bottom: 0.25rem;">Brand DNA Report</div>
              <div style="color: #6b7280; font-size: 0.95rem;">Your brand story, values, and audience</div>
            </div>
          </div>

          <div style="margin-bottom: 1rem; display: flex; align-items: start;">
            <span style="font-size: 2rem; margin-right: 1rem;">ğŸ“Š</span>
            <div>
              <div style="font-weight: 700; font-size: 1.1rem; margin-bottom: 0.25rem;">Intelligence Report</div>
              <div style="color: #6b7280; font-size: 0.95rem;">FREE geographic insights</div>
            </div>
          </div>

          <div style="display: flex; align-items: start;">
            <span style="font-size: 2rem; margin-right: 1rem;">ğŸš€</span>
            <div>
              <div style="font-weight: 700; font-size: 1.1rem; margin-bottom: 0.25rem;">Subscription Link</div>
              <div style="color: #6b7280; font-size: 0.95rem;">Unlock full access</div>
            </div>
          </div>
        </div>

        <button type="button" onclick="goToPricing()" class="btn-continue" style="
          width: 100%;
          margin-top: 1rem;
          justify-content: center;
        ">
          View Pricing & Subscribe Now
        </button>

        <p style="margin-top: 1.5rem; color: #6b7280; font-size: 0.9rem;">
          Didn't receive the email?
          <button onclick="resendEmail()" style="color: #667eea; font-weight: 600; background: none; border: none; cursor: pointer; text-decoration: underline;">
            Resend
          </button>
        </p>
      </div>
    </div>

  </div>
  </div>

  <script>
    // Configuration
    const ENV_CONFIG = window.getEnvConfig();
        const SUPABASE_URL = ENV_CONFIG.SUPABASE_URL;
    const SUPABASE_ANON_KEY = ENV_CONFIG.SUPABASE_ANON_KEY;

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // State
    const steps = ['step-1', 'step-2a', 'step-2b', 'step-2c', 'step-2d', 'step-2e', 'step-2f', 'step-2g', 'step-2h', 'step-3', 'step-processing', 'step-4'];
    let currentStepIndex = 0;
    let brandData = {};
    let brandId = null;
    let userId = null;
    let userEmail = null;
    let accessToken = null;

    // Initialize
    window.addEventListener('DOMContentLoaded', async () => {
      accessToken = localStorage.getItem('access_token');
      if (!accessToken) {
        window.location.href = '/login.html';
        return;
      }

      const { data: { user }, error } = await supabase.auth.getUser(accessToken);
      if (error || !user) {
        window.location.href = '/login.html';
        return;
      }
      userId = user.id;
      userEmail = user.email;

      // Check if user already has a brand
      const { data: existingBrands } = await supabase
        .from('user_brands')
        .select('brand_id')
        .eq('user_id', userId);

      if (existingBrands && existingBrands.length > 0) {
        window.location.href = '/dashboard.html';
        return;
      }

      // Enable Enter key navigation
      enableEnterKey();
    });

    function enableEnterKey() {
      document.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          const currentStep = steps[currentStepIndex];
          const activeElement = document.activeElement;

          if (activeElement.tagName === 'TEXTAREA') return;

          if (currentStep === 'step-1') validateAndContinue(1);
          else if (currentStep === 'step-2a') validateAndContinue(2);
          else if (currentStep === 'step-2b') validateAndContinue(3);
          else if (currentStep === 'step-2c') validateAndContinue(4);
          else if (currentStep === 'step-2d') validateAndContinue(5);
          else if (currentStep === 'step-2e') validateAndContinue(6);
          else if (currentStep === 'step-2f') validateAndContinue(7);
          else if (currentStep === 'step-2g') validateAndContinue(8);
          else if (currentStep === 'step-2h') submitStep2();
        }
      });
    }

    async function validateAndContinue(step) {
      if (step === 1) {
        const brandName = document.getElementById('brand_name').value.trim();
        if (!brandName) {
          alert('Please enter your brand name');
          return;
        }
        brandData.brand_name = brandName;

        // Create brand immediately
        try {
          const response = await fetch(`${SUPABASE_URL}/functions/v1/onboarding-wizard-handler`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${accessToken}`,
              'apikey': SUPABASE_ANON_KEY,
            },
            body: JSON.stringify({
              action: 'step1_create_brand',
              user_id: userId,
              brand_name: brandData.brand_name,
              category: 'Pending',
              country: 'Pending',
              description: 'Pending'
            })
          });

          const data = await response.json();
          if (data.success) {
            brandId = data.brand.id;
            goToNextStep();
          } else {
            alert(data.error || 'Failed to create brand');
          }
        } catch (error) {
          alert('Network error. Please try again.');
        }
      } else if (step === 2) {
        const category = document.getElementById('category').value;
        if (!category) {
          alert('Please select a category');
          return;
        }
        brandData.category = category;
        goToNextStep();
      } else if (step === 3) {
        const country = document.getElementById('country').value;
        if (!country) {
          alert('Please select a country');
          return;
        }
        brandData.country = country;
        goToNextStep();
      } else if (step === 4) {
        const description = document.getElementById('description').value.trim();
        if (!description) {
          alert('Please tell us about your brand');
          return;
        }
        brandData.description = description;
        goToNextStep();
      } else if (step === 5) {
        brandData.website_url = document.getElementById('website_url').value.trim();
        goToNextStep();
      } else if (step === 6) {
        brandData.instagram_url = document.getElementById('instagram_url').value.trim();
        goToNextStep();
      } else if (step === 7) {
        brandData.tiktok_url = document.getElementById('tiktok_url').value.trim();
        goToNextStep();
      } else if (step === 8) {
        brandData.youtube_url = document.getElementById('youtube_url').value.trim();
        goToNextStep();
      }
    }

    async function submitStep2() {
      brandData.whatsapp_number = document.getElementById('whatsapp_number').value.trim();

      // Update brand with all info
      try {
        const response = await fetch(`${SUPABASE_URL}/functions/v1/onboarding-wizard-handler`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${accessToken}`,
            'apikey': SUPABASE_ANON_KEY,
          },
          body: JSON.stringify({
            action: 'step2_add_socials',
            brand_id: brandId,
            category: brandData.category,
            country: brandData.country,
            description: brandData.description,
            website_url: brandData.website_url,
            instagram_url: brandData.instagram_url,
            tiktok_url: brandData.tiktok_url,
            youtube_url: brandData.youtube_url,
            whatsapp_number: brandData.whatsapp_number
          })
        });

        const data = await response.json();
        if (data.success) {
          showReviewData();
          goToNextStep();
        } else {
          alert(data.error || 'Failed to save data');
        }
      } catch (error) {
        alert('Network error. Please try again.');
      }
    }

    function showReviewData() {
      document.getElementById('review-brand-name').textContent = brandData.brand_name;
      document.getElementById('review-category').textContent = brandData.category;
      document.getElementById('review-country').textContent = brandData.country;
    }

    async function confirmAndLock() {
      // Go to processing
      goToNextStep();

      try {
        // Lock brand
        const lockResponse = await fetch(`${SUPABASE_URL}/functions/v1/onboarding-wizard-handler`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${accessToken}`,
            'apikey': SUPABASE_ANON_KEY,
          },
          body: JSON.stringify({
            action: 'step4_confirm_and_lock',
            brand_id: brandId
          })
        });

        // Start ingestion (DNA + Report generation)
        const ingestionResponse = await fetch(`${SUPABASE_URL}/functions/v1/onboarding-wizard-handler`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${accessToken}`,
            'apikey': SUPABASE_ANON_KEY,
          },
          body: JSON.stringify({
            action: 'step5_start_ingestion',
            brand_id: brandId
          })
        });

        // Simulate processing time
        setTimeout(() => {
          document.getElementById('user-email').textContent = userEmail;
          goToNextStep();
        }, 3000);

      } catch (error) {
        setTimeout(() => {
          document.getElementById('user-email').textContent = userEmail;
          goToNextStep();
        }, 3000);
      }
    }

    function goToNextStep() {
      document.getElementById(steps[currentStepIndex]).classList.remove('active');
      currentStepIndex++;
      document.getElementById(steps[currentStepIndex]).classList.add('active');
      updateProgressDots();
    }

    function goBack() {
      document.getElementById(steps[currentStepIndex]).classList.remove('active');
      currentStepIndex--;
      document.getElementById(steps[currentStepIndex]).classList.add('active');
      updateProgressDots();
    }

    function updateProgressDots() {
      const dots = document.querySelectorAll('.progress-dot');
      let progressStep = 0;

      if (currentStepIndex === 0) progressStep = 0;
      else if (currentStepIndex >= 1 && currentStepIndex <= 8) progressStep = 1;
      else if (currentStepIndex === 9) progressStep = 2;
      else if (currentStepIndex >= 10) progressStep = 3;

      dots.forEach((dot, index) => {
        if (index === progressStep) {
          dot.classList.add('active');
        } else {
          dot.classList.remove('active');
        }
      });
    }

    function goToPricing() {
      window.location.href = '/pricing.html';
    }

    async function resendEmail() {
      alert('Email resent! Please check your inbox.');
    }
  </script>

</body>
</html>
