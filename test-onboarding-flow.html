<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Onboarding Flow - GeoVera</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Monaco', 'Courier New', monospace;
            background: #1a1a2e;
            color: #eee;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 24px;
        }

        .section {
            background: #16213e;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
        }

        .section h2 {
            color: #64ffda;
            font-size: 18px;
            margin-bottom: 15px;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            margin-right: 10px;
            margin-bottom: 10px;
            transition: all 0.3s;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .log {
            background: #0f1419;
            border-radius: 6px;
            padding: 15px;
            margin-top: 15px;
            max-height: 400px;
            overflow-y: auto;
            font-size: 13px;
        }

        .log-entry {
            margin-bottom: 8px;
            padding: 4px 0;
            border-bottom: 1px solid #1a1a2e;
        }

        .log-entry:last-child {
            border-bottom: none;
        }

        .success {
            color: #10B981;
        }

        .error {
            color: #EF4444;
        }

        .info {
            color: #64ffda;
        }

        .warning {
            color: #F59E0B;
        }

        .step-indicator {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
            margin-right: 8px;
        }

        input, select {
            width: 100%;
            padding: 10px;
            margin: 8px 0;
            background: #0f1419;
            border: 2px solid #2a2a3e;
            color: #eee;
            border-radius: 6px;
            font-size: 14px;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }

        label {
            display: block;
            color: #64ffda;
            font-size: 13px;
            margin-top: 12px;
            margin-bottom: 4px;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .status {
            background: #0f1419;
            padding: 10px 15px;
            border-radius: 6px;
            margin-top: 10px;
        }

        .status strong {
            color: #667eea;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ GeoVera Onboarding Flow Tester</h1>

        <!-- Login Section -->
        <div class="section">
            <h2>1Ô∏è‚É£ Authentication (Login/Signup)</h2>
            <label>Email</label>
            <input type="email" id="test-email" placeholder="test@example.com" value="test.onboarding@geovera.com">

            <label>Password</label>
            <input type="password" id="test-password" placeholder="password123" value="TestPass123!">

            <button onclick="testSignup()">üîê Sign Up (New User)</button>
            <button onclick="testLogin()">üîë Login (Existing User)</button>

            <div class="status" id="auth-status">
                <strong>Status:</strong> Not authenticated
            </div>
        </div>

        <!-- Onboarding Section -->
        <div class="section">
            <h2>2Ô∏è‚É£ 5-Step Onboarding Flow</h2>

            <div class="grid">
                <div>
                    <label>Brand Name</label>
                    <input type="text" id="brand-name" value="Test Brand Kopi">
                </div>
                <div>
                    <label>Category</label>
                    <select id="category">
                        <option value="fnb">Food & Beverage</option>
                        <option value="beauty">Beauty</option>
                        <option value="fashion">Fashion</option>
                        <option value="saas">SaaS</option>
                    </select>
                </div>
                <div>
                    <label>Business Type</label>
                    <select id="business-type">
                        <option value="hybrid">Hybrid</option>
                        <option value="online">Online</option>
                        <option value="offline">Offline</option>
                    </select>
                </div>
                <div>
                    <label>Country</label>
                    <select id="country">
                        <option value="ID">Indonesia</option>
                        <option value="US">United States</option>
                        <option value="SG">Singapore</option>
                    </select>
                </div>
            </div>

            <button onclick="testStep1()">‚ñ∂Ô∏è Step 1: Welcome</button>
            <button onclick="testStep2()">‚ñ∂Ô∏è Step 2: Brand Info</button>
            <button onclick="testStep3()">‚ñ∂Ô∏è Step 3: Social Media</button>
            <button onclick="testStep4()">‚ñ∂Ô∏è Step 4: Confirmation</button>
            <button onclick="testStep5Skip()">‚ñ∂Ô∏è Step 5: Skip Tier</button>
            <button onclick="testStep5Tier()">‚ñ∂Ô∏è Step 5: Select Premium</button>
            <button onclick="testCompleteFlow()" style="background: #10B981;">üöÄ RUN COMPLETE FLOW</button>
        </div>

        <!-- Database Verification -->
        <div class="section">
            <h2>3Ô∏è‚É£ Database Verification</h2>
            <button onclick="checkCategories()">üìã Check 18 Categories</button>
            <button onclick="checkPricing()">üí∞ Check Pricing</button>
            <button onclick="checkBrandCreated()">üè¢ Check Brand Created</button>
            <button onclick="checkEmailQueue()">üìß Check Email Queue</button>
        </div>

        <!-- Console Log -->
        <div class="section">
            <h2>üìä Test Console</h2>
            <button onclick="clearLog()">üóëÔ∏è Clear Log</button>
            <div class="log" id="log"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="env-loader.js"></script>
    <script>
        const ENV_CONFIG = window.getEnvConfig();
        const SUPABASE_URL = ENV_CONFIG.SUPABASE_URL;
        const SUPABASE_ANON_KEY = ENV_CONFIG.SUPABASE_ANON_KEY;

        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        let accessToken = null;
        let brandId = null;

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            const timestamp = new Date().toLocaleTimeString();
            entry.innerHTML = `[${timestamp}] ${message}`;
            logDiv.insertBefore(entry, logDiv.firstChild);
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
            log('Console cleared', 'info');
        }

        async function testSignup() {
            const email = document.getElementById('test-email').value;
            const password = document.getElementById('test-password').value;

            log(`üîê Attempting signup: ${email}`, 'info');

            try {
                const { data, error } = await supabase.auth.signUp({
                    email: email,
                    password: password,
                });

                if (error) throw error;

                accessToken = data.session?.access_token;
                log(`‚úÖ Signup successful! User: ${data.user.id}`, 'success');
                document.getElementById('auth-status').innerHTML = `<strong>Status:</strong> ‚úÖ Authenticated as ${email}`;
            } catch (error) {
                log(`‚ùå Signup failed: ${error.message}`, 'error');
            }
        }

        async function testLogin() {
            const email = document.getElementById('test-email').value;
            const password = document.getElementById('test-password').value;

            log(`üîë Attempting login: ${email}`, 'info');

            try {
                const { data, error } = await supabase.auth.signInWithPassword({
                    email: email,
                    password: password,
                });

                if (error) throw error;

                accessToken = data.session.access_token;
                log(`‚úÖ Login successful! User: ${data.user.id}`, 'success');
                document.getElementById('auth-status').innerHTML = `<strong>Status:</strong> ‚úÖ Authenticated as ${email}`;
            } catch (error) {
                log(`‚ùå Login failed: ${error.message}`, 'error');
            }
        }

        async function callOnboardingAPI(stepData) {
            if (!accessToken) {
                log('‚ùå Not authenticated. Please login first.', 'error');
                return null;
            }

            try {
                const response = await fetch(`${SUPABASE_URL}/functions/v1/onboard-brand-v4`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${accessToken}`,
                        'apikey': SUPABASE_ANON_KEY,
                    },
                    body: JSON.stringify(stepData)
                });

                const result = await response.json();
                return { ok: response.ok, data: result };
            } catch (error) {
                log(`‚ùå Network error: ${error.message}`, 'error');
                return null;
            }
        }

        async function testStep1() {
            log('<span class="step-indicator">STEP 1</span> Welcome to GeoVera...', 'info');
            const result = await callOnboardingAPI({ step: 1 });

            if (result && result.ok) {
                log(`‚úÖ Step 1 completed: ${result.data.message}`, 'success');
            } else {
                log(`‚ùå Step 1 failed: ${result?.data?.error || 'Unknown error'}`, 'error');
            }
        }

        async function testStep2() {
            log('<span class="step-indicator">STEP 2</span> Creating brand...', 'info');

            const data = {
                step: 2,
                brand_name: document.getElementById('brand-name').value,
                category: document.getElementById('category').value,
                business_type: document.getElementById('business-type').value,
                country: document.getElementById('country').value,
                google_maps_url: 'https://maps.google.com/test',
                description: 'Test brand for onboarding flow'
            };

            const result = await callOnboardingAPI(data);

            if (result && result.ok) {
                brandId = result.data.brand_id;
                log(`‚úÖ Step 2 completed: Brand created with ID: ${brandId}`, 'success');
                log(`üìä Brand: ${result.data.brand.brand_name} | Category: ${result.data.brand.category}`, 'info');
            } else {
                log(`‚ùå Step 2 failed: ${result?.data?.error || 'Unknown error'}`, 'error');
                if (result?.data?.details) {
                    result.data.details.forEach(err => log(`   ‚îî‚îÄ ${err}`, 'warning'));
                }
            }
        }

        async function testStep3() {
            if (!brandId) {
                log('‚ùå No brand_id. Please complete Step 2 first.', 'error');
                return;
            }

            log('<span class="step-indicator">STEP 3</span> Adding social media links...', 'info');

            const data = {
                step: 3,
                brand_id: brandId,
                web_url: 'https://testbrand.com',
                instagram_url: 'https://instagram.com/testbrand',
                whatsapp: '+628123456789'
            };

            const result = await callOnboardingAPI(data);

            if (result && result.ok) {
                log(`‚úÖ Step 3 completed: Social media links saved`, 'success');
            } else {
                log(`‚ùå Step 3 failed: ${result?.data?.error || 'Unknown error'}`, 'error');
            }
        }

        async function testStep4() {
            if (!brandId) {
                log('‚ùå No brand_id. Please complete Step 2 first.', 'error');
                return;
            }

            log('<span class="step-indicator">STEP 4</span> Confirming 30-day lock...', 'info');

            const data = {
                step: 4,
                brand_id: brandId,
                understood_30day_lock: true,
                confirmation_text: 'SAYA SETUJU'
            };

            const result = await callOnboardingAPI(data);

            if (result && result.ok) {
                log(`‚úÖ Step 4 completed: Confirmation recorded`, 'success');
                log(`‚ö†Ô∏è  ${result.data.warning}`, 'warning');
            } else {
                log(`‚ùå Step 4 failed: ${result?.data?.error || 'Unknown error'}`, 'error');
            }
        }

        async function testStep5Skip() {
            if (!brandId) {
                log('‚ùå No brand_id. Please complete Step 2 first.', 'error');
                return;
            }

            log('<span class="step-indicator">STEP 5</span> Skipping tier selection...', 'info');

            const data = {
                step: 5,
                brand_id: brandId,
                skip_tier_selection: true
            };

            const result = await callOnboardingAPI(data);

            if (result && result.ok) {
                log(`‚úÖ Step 5 completed (SKIPPED): ${result.data.message}`, 'success');
                log(`üìß ${result.data.email_report}`, 'info');
            } else {
                log(`‚ùå Step 5 failed: ${result?.data?.error || 'Unknown error'}`, 'error');
            }
        }

        async function testStep5Tier() {
            if (!brandId) {
                log('‚ùå No brand_id. Please complete Step 2 first.', 'error');
                return;
            }

            log('<span class="step-indicator">STEP 5</span> Selecting Premium tier (yearly)...', 'info');

            const data = {
                step: 5,
                brand_id: brandId,
                tier: 'premium',
                billing_cycle: 'yearly'
            };

            const result = await callOnboardingAPI(data);

            if (result && result.ok) {
                log(`‚úÖ Step 5 completed (TIER SELECTED): ${result.data.message}`, 'success');
                log(`üí∞ Pricing: ${result.data.pricing.tier_name} - $${result.data.pricing.total_price}/yr (Save $${result.data.pricing.yearly_savings})`, 'success');
                log(`üìß ${result.data.email_report}`, 'info');
            } else {
                log(`‚ùå Step 5 failed: ${result?.data?.error || 'Unknown error'}`, 'error');
            }
        }

        async function testCompleteFlow() {
            log('üöÄ ========== STARTING COMPLETE FLOW TEST ==========', 'info');

            await new Promise(r => setTimeout(r, 500));
            await testStep1();

            await new Promise(r => setTimeout(r, 800));
            await testStep2();

            await new Promise(r => setTimeout(r, 800));
            await testStep3();

            await new Promise(r => setTimeout(r, 800));
            await testStep4();

            await new Promise(r => setTimeout(r, 800));
            await testStep5Tier();

            log('üéâ ========== COMPLETE FLOW TEST FINISHED ==========', 'success');
        }

        async function checkCategories() {
            log('üìã Checking 18 categories...', 'info');
            const { data, error } = await supabase.rpc('execute_sql', {
                query: "SELECT unnest(enum_range(NULL::brand_category_enum)) AS category ORDER BY category"
            });

            if (error) {
                log(`‚ùå Failed to check categories: ${error.message}`, 'error');
            } else {
                log(`‚úÖ Found ${data.length} categories`, 'success');
                if (data.length === 18) {
                    log(`‚úÖ Category count is correct (18)`, 'success');
                } else {
                    log(`‚ùå Expected 18 categories, found ${data.length}`, 'error');
                }
            }
        }

        async function checkPricing() {
            log('üí∞ Checking subscription pricing...', 'info');
            const { data, error } = await supabase
                .from('gv_subscription_pricing')
                .select('*')
                .order('monthly_price_usd');

            if (error) {
                log(`‚ùå Failed to check pricing: ${error.message}`, 'error');
            } else {
                log(`‚úÖ Found ${data.length} pricing tiers`, 'success');
                data.forEach(tier => {
                    log(`   üíµ ${tier.tier.toUpperCase()}: $${tier.monthly_price_usd}/mo | $${tier.yearly_price_usd}/yr (save $${tier.yearly_price_usd - (tier.monthly_price_usd * 11)}/yr)`, 'info');
                });
            }
        }

        async function checkBrandCreated() {
            if (!brandId) {
                log('‚ùå No brand_id set. Create a brand first.', 'error');
                return;
            }

            log(`üè¢ Checking brand: ${brandId}...`, 'info');
            const { data, error } = await supabase
                .from('gv_brands')
                .select('*')
                .eq('id', brandId)
                .single();

            if (error) {
                log(`‚ùå Failed to check brand: ${error.message}`, 'error');
            } else {
                log(`‚úÖ Brand found: ${data.brand_name}`, 'success');
                log(`   üìä Category: ${data.category} | Type: ${data.business_type} | Country: ${data.country}`, 'info');
                log(`   üí≥ Tier: ${data.subscription_tier || 'none'} | Billing: ${data.billing_cycle || 'none'}`, 'info');
                log(`   ‚úÖ Onboarding completed: ${data.onboarding_completed}`, data.onboarding_completed ? 'success' : 'warning');
            }
        }

        async function checkEmailQueue() {
            log('üìß Checking email queue...', 'info');
            const { data, error } = await supabase
                .from('gv_onboarding_email_queue')
                .select('*')
                .order('created_at', { ascending: false })
                .limit(5);

            if (error) {
                log(`‚ùå Failed to check email queue: ${error.message}`, 'error');
            } else {
                log(`‚úÖ Found ${data.length} emails in queue`, 'success');
                data.forEach((email, i) => {
                    log(`   üì® [${i+1}] ${email.report_type} | Status: ${email.status} | To: ${email.email}`, 'info');
                });
            }
        }

        // Initial log
        log('üß™ GeoVera Onboarding Tester Ready!', 'success');
        log('üëâ Step 1: Login or Sign Up', 'info');
        log('üëâ Step 2: Run individual steps OR click "RUN COMPLETE FLOW"', 'info');
    </script>
</body>
</html>
